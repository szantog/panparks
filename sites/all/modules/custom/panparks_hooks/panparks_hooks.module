<?php

/**
 * @file
 *   panparks_hooks.module
 * Project:panparks
 *    Overriden hooks for panparks.org
 *
 * @developers:
 *    Gabor Szanto <hello@szantogabor.com>
 *    http://szantogabor.com
 *
 */

/**
 * Implementation of hook_form_alter().
 */
function panparks_hooks_form_alter(&$form, $form_state, $form_id) {
  //dsm($form_id);
}


/**
 * Implementation of hook_form_media_edit_alter().
 */
function panparks_hooks_form_media_edit_alter(&$form, &$form_state) {
  if (isset($form['media_title'])) {
    $form['media_title'][LANGUAGE_NONE][0]['value']['#description'] = t('Title is used on colorbox, and in the alt/title attributes of image');
  }
}

/**
 * Implementation of hook_form_media_add_upload_alter().
 */
function panparks_hooks_form_media_add_upload_alter(&$form, &$form_state) {
  //If file does'nt exist, set default folder to Images
  $types = array();
  foreach ($form['#validators']['media_file_validate_types'] as $key => $value) {
    foreach ($value as $type_key => $type) {
      $types[] = $type;
    }
  }
  if (!isset($form['field_folder']['#default_value']) && in_array('image', $types)) {
    $form['field_folder']['#default_value'] = '24';
  }
}

/*
 * Implements hook_node_presave
 */
function panparks_hooks_node_presave($node) {
  //
  // Workaround for Feeds module setting text format to Plain Text instead of Full HTML or Filtered HTML
  //
  if ($node->type == 'transferred_blog_posts') {
    $node->body['und'][0]['format'] = 'full_html';
  }
}

/**
 * Theme preprocess function for theme_field() and field.tpl.php.
 *
 * @see theme_field()
 * @see field.tpl.php
 */
function panparks_hooks_preprocess_field(&$variables, $hook) {
  $element = $variables['element'];
  if ($element['#formatter'] == 'image') {
    foreach (element_children($element) as $item) {
      $element[$item]['#prefix'] ='test';
    }
  $variables['element'] = $element;
  //kpr(get_defined_vars());
  }

}

function panparks_hooks_preprocess_node(&$variables, $hook) {
  $content = $variables['content'];

  foreach (element_children($content) as $key) {
    if (isset($content[$key]['#field_type']) && ($content[$key]['#field_type'] == 'image' || $content[$key]['#field_type'] == 'media')) {
      foreach (element_children($content[$key]) as $delta) {
        if (is_numeric($delta)) {
          $path = 'media/' . $content[$key]['#items'][$delta]['fid'] . '/edit';
          $menu_item = menu_get_item($path);
          if ($menu_item['access']) {
          $link = array(
            '#type' => 'link',
            '#href' => $path,
            '#title' => t('Edit image'),
            '#options' => array(
              'attributes' => array('class' => array('media-edit-link'), 'id' => 'cool-id'),
              'html' => FALSE,
              'query' => array('destination' => $_GET['q']),
            ),
          );
          $content[$key][$delta]['#prefix'] = drupal_render($link);
          }
        }
      }
    }
  }
  //kpr(get_defined_vars());
  $variables['content'] = $content;
}