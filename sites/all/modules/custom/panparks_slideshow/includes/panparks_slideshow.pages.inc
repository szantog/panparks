<?php

/**
 * Menu callback; Generate a listing of enabled domains.
 */
function panparks_slideshow_overview_page() {
  $slideshows = panparks_slideshow_load_multiple(array(), array('type' => 'slideshow'));

  $header = array('ID', 'Title', array('data' => 'Operations', 'colspan' => 2));
  $rows = array();
  foreach ($slideshows as $slideshow) {
    $row = array();
    $row[] = array(
      'data' => $slideshow->slid,
      'class' => 'slid',
    );

    $slideshow_title = field_get_items('panparks_slideshow', $slideshow, 'slideshow_title');
    $row[] = array(
      'data' => field_view_value('panparks_slideshow', $slideshow, 'slideshow_title', $slideshow_title[0]),
      'class' => 'title',
    );

    $row[] = array(
      'data' => l(t('Edit'), 'slideshow/' . $slideshow->slid),
      'class' => 'slideshow',
    );
    $row[] = array(
      'data' => l(t('Delete'), 'slideshow/' . $slideshow->slid . '/delete'),
      'class' => 'slideshow',
    );
    $rows[$slideshow->slid] = $row;
  }

  if (count($rows)) {
    return theme('table', array('header' => $header, 'rows' => $rows));
  }

  return t('No slideshow available. <a href="@link">Add slideshow</a>.', array('@link' => url('slideshow/add')));
}


/**
 * Returns a slideshow submission form.
 */
function panparks_slideshow_add() {
  $slideshow = (object) array(
    'uid' => $GLOBALS['user']->uid,
    'type' => 'slideshow',
    'language' => LANGUAGE_NONE,
    'created' => REQUEST_TIME,
  );
  drupal_set_title(t('Add slideshow item'), PASS_THROUGH);
  $output = drupal_get_form('panparks_slideshow_form', $slideshow);

  return $output;
}

/**
 * Menu callback; presents the slideshow editing form, or redirects to delete confirmation.
 */
function panparks_slideshow_edit($slideshow) {
  drupal_set_title(t('Edit slideshow: #%slid', array('%slid' => $slideshow->slid)), PASS_THROUGH);
  return drupal_get_form('panparks_slideshow_form', $slideshow);
}

/**
 * Generate the slideshow add/edit form array.
 */
function panparks_slideshow_form($form, &$form_state, $slideshow) {
  if (!isset($form_state['slideshow'])) {
    $form_state['slideshow'] = $slideshow;
  }
  else {
    $slideshow = $form_state['slideshow'];
  }

  // Basic slideshow information.
  // These elements are just values so they are not even sent to the client.
  foreach (array('slid', 'uid', 'created', 'type') as $key) {
    $form[$key] = array(
      '#type' => 'value',
      '#value' => isset($slideshow->$key) ? $slideshow->$key : NULL,
    );
  }

  // Changed must be sent to the client, for later overwrite error checking.
  $form['changed'] = array(
    '#type' => 'hidden',
    '#default_value' => isset($slideshow->changed) ? $slideshow->changed : NULL,
  );

  // Add the buttons.
  $form['actions'] = array('#type' => 'actions');
  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
    '#weight' => 5,
    '#submit' => array('panparks_slideshow_form_submit'),
  );

  if (!empty($slideshow->did) && user_access('administer panparks slideshow')) {
    $form['actions']['delete'] = array(
      '#type' => 'submit',
      '#value' => t('Delete'),
      '#weight' => 15,
      '#submit' => array('panparks_slideshow_form_delete_submit'),
    );
  }

  $form['#validate'][] = 'panparks_slideshow_form_validate';
  $form += array('#submit' => array());

  field_attach_form('panparks_slideshow', $slideshow, $form, $form_state, LANGUAGE_NONE);
  return $form;
}

/**
 * Validates the slideshow form generated by panparks_slideshow_form().
 */
function panparks_slideshow_form_validate($form, &$form_state) {
  entity_form_field_validate('panparks_slideshow', $form, $form_state);
}

/**
 * Submit the slideshow form generated by panparks_slideshow_form().
 */
function panparks_slideshow_form_submit($form, &$form_state) {
  $slideshow = $form_state['slideshow'];
  entity_form_submit_build_entity('panparks_slideshow', $slideshow, $form, $form_state);
  $insert = empty($slideshow->slid);

  panparks_slideshow_save($slideshow);

  $slideshow_link = l(t('view'), 'slideshow/' . $slideshow->slid);

  if ($insert) {
    watchdog('panparks_slideshow', 'Slideshow added #%slid.', array('%slid' => $slideshow->slid), WATCHDOG_NOTICE, $slideshow_link);
    drupal_set_message(t('Slideshow #%slid has been created.', array('%slid' => $slideshow->slid)));
  }
  else {
    watchdog('panparks_slideshow', 'Slideshow updated #%slid.', array('%slid' => $slideshow->slid), WATCHDOG_NOTICE, $slideshow_link);
    drupal_set_message(t('Slideshow #%slid has been updated.', array('%slid' => $slideshow->slid)));
  }
  if ($slideshow->slid) {
    $form_state['values']['slid'] = $slideshow->slid;
    $form_state['slid'] = $slideshow->slid;
    $form_state['redirect'] = 'slideshow/' . $slideshow->slid;
  }
  else {
    // In the unlikely case something went wrong on save, the slideshow will be
    // rebuilt and slideshow form redisplayed the same way as in preview.
    drupal_set_message(t('The post could not be saved.'), 'error');
    $form_state['rebuild'] = TRUE;
  }
  // Clear the page and block caches.
  cache_clear_all();
}
